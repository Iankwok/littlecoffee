app.controller('FlavoursCtrl', ['$scope', '$auth', '$http', function($scope, $auth, $http){

  $scope.checkOut = checkOut;
  $scope.newOrder ={};
  $scope.cart = {};

  $scope.preferences = {
    filter: [],
    berry: {
      imgOn:  "<%= asset_path('berry.jpg') %>",
      imgOff: "<%= asset_path('berry_off.jpg') %>",
      active: false
    },
    chocolate: {
      imgOn:  "<%= asset_path('chocolate.jpg') %>",
      imgOff: "<%= asset_path('chocolate_off.jpg') %>",
      active: false
    },
    citrus: {
      imgOn:  "<%= asset_path('citrus.jpg') %>",
      imgOff: "<%= asset_path('citrus_off.jpg') %>",
      active: false
    },
    nuts: {
      imgOn:  "<%= asset_path('nuts.jpg') %>",
      imgOff: "<%= asset_path('nuts_off.jpg') %>",
      active: false
    },
    spices: {
      imgOn:  "<%= asset_path('spices.jpg') %>",
      imgOff: "<%= asset_path('spices_off.jpg') %>",
      active: false
    },
    tropical_fruit: {
      imgOn:  "<%= asset_path('tropical_fruit.jpg') %>",
      imgOff: "<%= asset_path('tropical_fruit_off.jpg') %>",
      active: false
    },
  }

  $scope.toggleInput = function (p) {
    var pCapitalized = p.capitalize();
    var pIndex = $scope.preferences.filter.indexOf(pCapitalized);
    if (pIndex !== -1) {
      $scope.preferences.filter.splice(pIndex, 1);
    } else {
      $scope.preferences.filter.push(pCapitalized);
    }

    $scope.preferences[p].active = !$scope.preferences[p].active;
  }

  $scope.filterPreference = function(bean) {
    if ($scope.preferences.filter.length == 0){
      return ($scope.preferences.filter.indexOf(bean.flavours) == -1);
    } else {
      return ($scope.preferences.filter.indexOf(bean.flavours) !== -1);
    }
  };

  function checkOut(){
    for(var key in $scope.cart){
      $http
      .post('http://localhost:3000/api/orders', {quantity: $scope.cart[key].quantity, bean_id: key})
      .success(function(data){
        console.log(data)
      });
    }
  }

  $scope.addToCart = function (bean){
    if ($scope.cart[bean.id]) {
      $scope.cart[bean.id].quantity += 1;
    } else {
      $scope.cart[bean.id] = bean;
      $scope.cart[bean.id].quantity = 1;
    }
  }

  $scope.deleteBean = function (key) {
    delete $scope.cart[key]
  }

  $scope.getTotal = function () {
    var total = 0;
    for(var key in $scope.cart){
      total += $scope.cart[key].quantity * $scope.cart[key].price;
    }
    return total;
  }

  function initializeCart (orderDetails) {
    orderDetails.forEach(function(detail, index, array){
      $scope.cart[detail.bean_id] = detail.bean;
      $scope.cart[detail.bean_id].quantity = detail.quantity;
    })
  }

// GET all beans
  $http({
    method: "GET",
    url: "http://localhost:3000/api/beans"
  }).then(function(data){
    $scope.beans = data.data;
  })

  $http({
    method: "GET",
    url: "http://localhost:3000/api/orders"
  }).then(function(data){
    console.log(data.data);
    $scope.orderDetails = data.data;
    if ($scope.orderDetails) {
      initializeCart($scope.orderDetails);
    }
  })

}])